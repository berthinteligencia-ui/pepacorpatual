generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── AUTH (NextAuth v5) ───────────────────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── MULTI-TENANT ────────────────────────────────────────────────────────────

model Company {
  id        String   @id @default(cuid())
  name      String
  cnpj      String?  @unique
  logo      String?
  whatsapp  String?
  email     String?
  address   String?
  city      String?
  state     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  employees   Employee[]
  departments Department[]
  payrollAnalyses PayrollAnalysis[]
  settings    Settings?
  conversations Conversation[]
}

model Settings {
  id                    String   @id @default(cuid())
  companyId             String   @unique
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  whatsappNotifications Boolean  @default(false)
  autoBackup            Boolean  @default(false)
  payrollReminderDays   Int      @default(5)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ─── USERS ───────────────────────────────────────────────────────────────────

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(RH)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  accounts Account[]
  sessions Session[]
}

enum Role {
  ADMIN
  RH
  GESTOR
  FUNCIONARIO
}

// ─── HR CORE ─────────────────────────────────────────────────────────────────

model Department {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  employees Employee[]
  payrollAnalyses PayrollAnalysis[]
}

model Employee {
  id         String         @id @default(cuid())
  name       String
  cpf        String?        @unique
  email      String?
  phone      String?
  position   String
  salary     Decimal        @db.Decimal(10, 2)
  hireDate   DateTime
  status     EmployeeStatus @default(ACTIVE)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  companyId    String
  company      Company     @relation(fields: [companyId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  conversations Conversation[]
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

// ─── BANKS ───────────────────────────────────────────────────────────────────

model Bank {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PayrollAnalysis {
  id           String   @id @default(cuid())
  month        Int
  year         Int
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id])
  data         Json     // Stores { found, missing, extras, sheetSummary }
  total        Decimal  @db.Decimal(10, 2)
  status       String   @default("OPEN")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([month, year, departmentId, companyId], name: "month_year_unit_company")
}

// ─── MESSAGING ───────────────────────────────────────────────────────────────

model Conversation {
  id        String   @id @default(cuid())
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  messages Message[]

  @@unique([companyId, employeeId])
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  senderId  String   // In common cases, the User.id or Employee.id
  senderType SenderType
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

enum SenderType {
  COMPANY   // Setor Admin/RH
  EMPLOYEE  // Funcionário
}

